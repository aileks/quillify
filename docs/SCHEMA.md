# Quillify Database Schema

This document describes the complete database schema for Quillify, including tables, columns, relationships, and constraints.

## Overview

- **Database**: PostgreSQL
- **Schema Name**: `quillify`
- **ORM**: Drizzle ORM
- **Schema File**: `src/server/db/schema.ts`
- **Migrations**: `src/server/drizzle/`

All tables are organized under the `quillify` PostgreSQL schema to avoid conflicts with other schemas in the same database.

---

## Tables

### users

User accounts with authentication credentials.

**Columns:**

| Column            | Type                       | Constraints             | Description                                                |
| ----------------- | -------------------------- | ----------------------- | ---------------------------------------------------------- |
| `id`              | `text`                     | PRIMARY KEY, NOT NULL   | UUID v4 generated by `crypto.randomUUID()`                 |
| `name`            | `text`                     | NULL                    | User's display name (optional)                             |
| `email`           | `text`                     | UNIQUE, NULL            | User's email address (unique constraint)                   |
| `password`        | `text`                     | NULL                    | Bcrypt hashed password (nullable for future OAuth support) |
| `emailVerifiedAt` | `timestamp with time zone` | NULL                    | Timestamp when email was verified                          |
| `createdAt`       | `timestamp with time zone` | NOT NULL, DEFAULT now() | Record creation timestamp                                  |
| `updatedAt`       | `timestamp with time zone` | NOT NULL, DEFAULT now() | Record last update timestamp                               |

**Indexes:**

- Unique constraint on `email`

**Relationships:**

- One-to-many with `books`

**Notes:**

- Password is nullable to support future OAuth providers that don't require passwords
- Email verification is optional (nullable `emailVerifiedAt`)
- All timestamps use timezone-aware `timestamp with time zone` type

---

### books

Book entries linked to users in their personal library.

**Columns:**

| Column          | Type                       | Constraints             | Description                                |
| --------------- | -------------------------- | ----------------------- | ------------------------------------------ |
| `id`            | `text`                     | PRIMARY KEY, NOT NULL   | UUID v4 generated by `crypto.randomUUID()` |
| `userId`        | `text`                     | NOT NULL, FOREIGN KEY   | References `users.id` (CASCADE on delete)  |
| `title`         | `text`                     | NOT NULL                | Book title                                 |
| `author`        | `text`                     | NOT NULL                | Book author name                           |
| `numberOfPages` | `integer`                  | NOT NULL                | Total number of pages (must be > 0)        |
| `genre`         | `text`                     | DEFAULT 'Other'         | Book genre/category (defaults to 'Other')  |
| `publishYear`   | `integer`                  | NOT NULL                | Year the book was published (must be > 0)  |
| `isRead`        | `boolean`                  | NOT NULL, DEFAULT false | Whether the book has been read             |
| `createdAt`     | `timestamp with time zone` | NOT NULL, DEFAULT now() | Record creation timestamp                  |
| `updatedAt`     | `timestamp with time zone` | NOT NULL, DEFAULT now() | Record last update timestamp               |

**Indexes:**

- Foreign key index on `userId` (automatically created by PostgreSQL)

**Foreign Keys:**

- `books.userId` → `users.id` (ON DELETE CASCADE, ON UPDATE NO ACTION)

**Relationships:**

- Many-to-one with `users` (many books belong to one user)

**Notes:**

- Cascade delete: When a user is deleted, all their books are automatically deleted
- Genre defaults to 'Other' if not specified
- `isRead` defaults to `false` for new books
- All timestamps use timezone-aware `timestamp with time zone` type

---

## Relationships

### users ↔ books

- **Type**: One-to-many
- **Direction**: One user has many books
- **Foreign Key**: `books.userId` references `users.id`
- **Cascade**: ON DELETE CASCADE (deleting a user deletes all their books)
- **Drizzle Relations**: Defined in `src/server/db/schema.ts`

```typescript
// Users can have many books
usersRelations = relations(users, ({ many }) => ({
  books: many(books),
}));

// Books belong to one user
booksRelations = relations(books, ({ one }) => ({
  user: one(users, {
    fields: [books.userId],
    references: [users.id],
  }),
}));
```

---

## Schema Definition

The schema is defined using Drizzle ORM in `src/server/db/schema.ts`:

```typescript
import { text, integer, boolean, timestamp, pgSchema } from 'drizzle-orm/pg-core';
import { relations } from 'drizzle-orm';

const quillify = pgSchema('quillify');

export const users = quillify.table('users', {
  id: text('id')
    .primaryKey()
    .$defaultFn(() => crypto.randomUUID()),
  name: text('name'),
  email: text('email').unique(),
  password: text('password'),
  emailVerifiedAt: timestamp('emailVerifiedAt', { mode: 'date', withTimezone: true }),
  createdAt: timestamp('createdAt', { withTimezone: true }).defaultNow().notNull(),
  updatedAt: timestamp('updatedAt', { withTimezone: true }).defaultNow().notNull(),
});

export const books = quillify.table('books', {
  id: text('id')
    .primaryKey()
    .$defaultFn(() => crypto.randomUUID()),
  userId: text('userId')
    .notNull()
    .references(() => users.id, { onDelete: 'cascade' }),
  title: text('title').notNull(),
  author: text('author').notNull(),
  numberOfPages: integer('numberOfPages').notNull(),
  genre: text('genre').default('Other'),
  publishYear: integer('publishYear').notNull(),
  isRead: boolean('isRead').notNull().default(false),
  createdAt: timestamp('createdAt', { withTimezone: true }).defaultNow().notNull(),
  updatedAt: timestamp('updatedAt', { withTimezone: true }).defaultNow().notNull(),
});
```

---

## Migrations

Schema changes are managed through Drizzle Kit migrations:

- **Migration Files**: `src/server/drizzle/0000_*.sql` through `0006_*.sql`
- **Configuration**: `drizzle.config.ts`
- **Schema Filter**: Only `quillify` schema tables are managed

### Migration History

1. **0000_short_wraith.sql** - Initial schema creation (users, books, accounts)
2. **0001_wakeful_mephisto.sql** - Schema updates
3. **0002_high_purple_man.sql** - Removed accounts table (switched to JWT sessions)
4. **0003_real_drax.sql** - Renamed `emailVerified` to `emailVerifiedAt`
5. **0004_sparkling_major_mapleleaf.sql** - Schema updates
6. **0005_steady_madame_masque.sql** - Renamed snake_case columns to camelCase
7. **0006_loose_manta.sql** - Added `updatedAt` columns and NOT NULL constraints

---

## TypeScript Types

Drizzle automatically infers TypeScript types from the schema:

```typescript
import { users, books } from '@/server/db/schema';

// Infer select type (for queries)
type User = typeof users.$inferSelect;
type Book = typeof books.$inferSelect;

// Infer insert type (for mutations)
type NewUser = typeof users.$inferInsert;
type NewBook = typeof books.$inferInsert;
```

These types are used throughout the application for type-safe database operations.

---

## Constraints and Validation

### Application-Level Validation

While the database schema provides basic constraints, additional validation is enforced at the application level via Zod schemas in tRPC procedures:

- **Email**: Must be valid email format
- **Password**: Minimum 8 characters, must contain uppercase, lowercase, and number
- **Name**: Minimum 2 characters (if provided)
- **Book Title/Author**: Minimum 1 character
- **NumberOfPages**: Must be positive integer
- **PublishYear**: Must be positive integer

### Database-Level Constraints

- **Primary Keys**: All tables use UUID text primary keys
- **Foreign Keys**: `books.userId` references `users.id` with CASCADE delete
- **Unique Constraints**: `users.email` must be unique
- **NOT NULL**: Required fields are enforced at the database level
- **Defaults**: `books.genre` defaults to 'Other', `books.isRead` defaults to `false`

---

## Notes

### Authentication Tables

Quillify uses **JWT-based sessions** (not database sessions), so there are no `sessions` or `accounts` tables. The `accounts` table was removed in migration `0002_high_purple_man.sql` when switching from database sessions to JWT sessions.

### Future Considerations

- **OAuth Support**: The `password` field is nullable to support future OAuth providers
- **Email Verification**: `emailVerifiedAt` is nullable and can be used for email verification workflows
- **Soft Deletes**: Currently using hard deletes (CASCADE), but soft deletes could be added with a `deletedAt` timestamp column

---

## Related Documentation

- [API.md](./API.md) - API architecture and tRPC setup
- [ROUTES.md](./ROUTES.md) - Complete list of tRPC procedures and endpoints
- [README.md](../README.md) - Project overview and setup instructions
